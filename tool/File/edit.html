<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Apple Support-->
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-title" content="PEX Server edit">
    <link
      rel="icon"
      href="https://pexserver.github.io/lib/Assets/images/home.png"
      type="image/x-icon"
    />
    <link
      rel="shortcut icon"
      href="https://pexserver.github.io/lib/Assets/images/home.png"
      type="image/x-icon"
    />
    <title>toolsData Editor Enhanced</title>
    <style>
      :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-color: #dee2e6;
        --input-bg: #fff;
        --input-border: #ced4da;
        --body-bg: #f4f7f9;
        --text-color: #212529;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        padding: 20px;
        background-color: var(--body-bg);
        color: var(--text-color);
        margin: 0;
      }

      .container {
        max-width: 900px;
        margin: 20px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1,
      h2,
      h3 {
        color: var(--dark-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 8px;
        margin-top: 30px;
        margin-bottom: 20px;
      }

      h1 {
        font-size: 2em;
      }

      h2 {
        font-size: 1.5em;
      }

      h3 {
        font-size: 1.25em;
        border-bottom-style: dashed;
        border-color: var(--border-color);
      }

      textarea,
      input[type="text"],
      input[type="date"],
      input[type="url"] {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 12px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      textarea:focus,
      input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
      }

      textarea {
        min-height: 150px;
        font-family: "Courier New", Courier, monospace;
      }

      #dataInput {
        min-height: 200px;
      }

      #dataOutput {
        min-height: 250px;
        background-color: var(--light-color);
      }

      #editForm textarea {
        min-height: 80px;
      }

      #editDetailedDescription {
        min-height: 120px;
      }

      button {
        padding: 10px 18px;
        margin: 5px 5px 5px 0;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        transition: background-color 0.2s ease-in-out, opacity 0.2s ease;
      }

      button:hover {
        opacity: 0.9;
      }

      #loadDataBtn,
      #addToolBtn {
        background-color: var(--primary-color);
        color: white;
      }

      #saveToolBtn {
        background-color: var(--success-color);
        color: white;
      }

      #deleteToolBtn {
        background-color: var(--danger-color);
        color: white;
      }

      #cancelEditBtn,
      #copyOutputBtn {
        background-color: var(--secondary-color);
        color: white;
      }

      #toolList {
        margin-top: 20px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0;
        max-height: 350px;
        overflow-y: auto;
        background-color: #fff;
      }

      .tool-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.15s ease;
      }

      .tool-item:last-child {
        border-bottom: none;
      }

      .tool-item:hover {
        background-color: var(--light-color);
      }

      .tool-item span {
        flex-grow: 1;
        margin-right: 15px;
        word-break: break-word;
      }

      .tool-item .tool-key {
        font-weight: bold;
        color: var(--primary-color);
        margin-right: 5px;
      }

      .tool-item button {
        padding: 5px 10px;
        font-size: 0.9rem;
        background-color: var(--primary-color);
        color: white;
      }

      #editFormContainer {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 25px;
        margin-top: 25px;
        background-color: #fff;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      }

      #editForm label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--dark-color);
        font-size: 0.95rem;
      }

      #editForm label .required {
        color: var(--danger-color);
        margin-left: 4px;
      }

      #editForm .form-buttons {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .hidden {
        display: none !important;
      }

      #outputArea {
        margin-top: 30px;
      }

      .error {
        color: var(--danger-color);
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px 15px;
        border-radius: 4px;
        margin-top: 10px;
        font-weight: bold;
        font-size: 0.95rem;
      }

      #saveError {
        margin-top: 15px;
      }

      #copyStatus {
        margin-left: 10px;
        font-weight: bold;
        font-size: 0.95rem;
      }

      #copyStatus.success {
        color: var(--success-color);
      }

      #copyStatus.fail {
        color: var(--danger-color);
      }

      .required {
        color: var(--danger-color);
        font-weight: bold;
        margin-left: 2px;
      }

      datalist {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>toolsData Editor</h1>

      <section id="inputArea">
        <h2>1. Load toolsData</h2>
        <p>
          既存の <code>toolsData</code> オブジェクトの内容全体 (<code
            >const toolsData = { ... };</code
          >
          の <code>{...}</code> の部分、またはJSON形式) を以下に貼り付けて「Load
          Data」ボタンを押してください。
        </p>
        <textarea
          id="dataInput"
          placeholder="{
    'tool1': {
        title: 'Example Tool',
        // ... other properties ...
    },
    // ... other tools ...
}"
        ></textarea>
        <button id="loadDataBtn">Load Data</button>
        <div id="loadError" class="error hidden"></div>
      </section>

      <section id="manageArea" class="hidden">
        <h2>2. Manage Tools</h2>
        <button id="addToolBtn">Add New Tool</button>
        <div id="toolList">
          <p style="padding: 15px; color: var(--secondary-color)">
            Load data to see tools.
          </p>
        </div>

        <div id="editFormContainer" class="hidden">
          <h3 id="formTitle">Edit Tool</h3>
          <form id="editForm" novalidate="">
            <input type="hidden" id="editToolId" />

            <div>
              <label for="editToolKey"
                >Tool Key<span class="required">*</span> (例: 'myTool',
                'utility-abc'):</label
              >
              <input type="text" id="editToolKey" required="" />
            </div>

            <div>
              <label for="editTitle">Title:</label>
              <input type="text" id="editTitle" />
            </div>

            <div>
              <label for="editImage">Image URL:</label>
              <input
                type="url"
                id="editImage"
                placeholder="例: ../Assets/images/tool.png"
              />
            </div>

            <div>
              <label for="editImageLarge">Large Image URL:</label>
              <input
                type="url"
                id="editImageLarge"
                placeholder="例: ../Assets/images/tool-large.png"
              />
            </div>

            <div>
              <label for="editCategory">Category:</label>
              <input
                type="text"
                id="editCategory"
                list="categorySuggestions"
                placeholder="例: 開発ツール, Minecraft"
              />
              <datalist id="categorySuggestions"></datalist>
            </div>

            <div>
              <label for="editVersion">Version:</label>
              <input type="text" id="editVersion" placeholder="例: 1.2.0" />
            </div>

            <div>
              <label for="editUpdated">Updated:</label>
              <input type="date" id="editUpdated" />
            </div>

            <div>
              <label for="editDescription">Description (Short):</label>
              <textarea id="editDescription"></textarea>
            </div>

            <div>
              <label for="editDetailedDescription"
                >Detailed Description (HTML allowed):</label
              >
              <textarea id="editDetailedDescription"></textarea>
            </div>

            <fieldset
              style="
                border: 1px solid var(--border-color);
                padding: 15px;
                margin-top: 15px;
                border-radius: 4px;
              "
            >
              <legend style="padding: 0 10px; font-weight: bold">
                Download URLs
              </legend>
              <div>
                <label for="editDownloadUrl"
                  >Download URL (Default/Single):</label
                >
                <input
                  type="text"
                  id="editDownloadUrl"
                  placeholder="例: ./File/tool.zip (If no platform-specific URLs)"
                />
              </div>
              <div>
                <label for="editDownloadUrlWindows"
                  >Download URL (Windows):</label
                >
                <input
                  type="text"
                  id="editDownloadUrlWindows"
                  placeholder="例: ./File/tool_win.exe"
                />
              </div>
              <div>
                <label for="editDownloadUrlLinux">Download URL (Linux):</label>
                <input
                  type="text"
                  id="editDownloadUrlLinux"
                  placeholder="例: ./File/tool_linux.tar.gz"
                />
              </div>
            </fieldset>

            <div>
              <label for="editDocsUrl">Docs URL:</label>
              <input
                type="url"
                id="editDocsUrl"
                placeholder="例: ./docs/tool_readme.html"
              />
            </div>

            <div>
              <label for="editPlatform">Platform:</label>
              <input
                type="text"
                id="editPlatform"
                list="platformSuggestions"
                placeholder="例: web, windows, linux (カンマ区切り)"
              />
              <datalist id="platformSuggestions"></datalist>
            </div>

            <div>
              <label for="editCategoryType">Category Type:</label>
              <input
                type="text"
                id="editCategoryType"
                list="categoryTypeSuggestions"
                placeholder="例: development, utility, minecraft"
              />
              <datalist id="categoryTypeSuggestions"></datalist>
            </div>

            <div class="form-buttons">
              <button type="submit" id="saveToolBtn">Save Tool</button>
              <button type="button" id="deleteToolBtn" class="hidden">
                Delete Tool
              </button>
              <button type="button" id="cancelEditBtn">Cancel</button>
            </div>
            <div id="saveError" class="error hidden"></div>
          </form>
        </div>
      </section>

      <section id="outputArea" class="hidden">
        <h2>3. Get Updated Data</h2>
        <p>
          編集後の
          <code>toolsData</code>
          オブジェクトです。コピーしてコードに貼り付けてください (JSON形式)。
        </p>
        <textarea id="dataOutput" readonly=""></textarea>
        <button id="copyOutputBtn">Copy to Clipboard</button>
        <span id="copyStatus"></span>
      </section>
    </div>

    <script>
      let currentToolsData = {};
      const suggestions = {
        categories: new Set(),
        platforms: new Set(),
        categoryTypes: new Set(),
      };

      const dataInput = document.getElementById("dataInput");
      const loadDataBtn = document.getElementById("loadDataBtn");
      const loadError = document.getElementById("loadError");
      const manageArea = document.getElementById("manageArea");
      const toolList = document.getElementById("toolList");
      const addToolBtn = document.getElementById("addToolBtn");
      const editFormContainer = document.getElementById("editFormContainer");
      const editForm = document.getElementById("editForm");
      const formTitle = document.getElementById("formTitle");
      const saveToolBtn = document.getElementById("saveToolBtn");
      const deleteToolBtn = document.getElementById("deleteToolBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");
      const saveError = document.getElementById("saveError");
      const outputArea = document.getElementById("outputArea");
      const dataOutput = document.getElementById("dataOutput");
      const copyOutputBtn = document.getElementById("copyOutputBtn");
      const copyStatus = document.getElementById("copyStatus");

      const categorySuggestionsEl = document.getElementById(
        "categorySuggestions"
      );
      const platformSuggestionsEl = document.getElementById(
        "platformSuggestions"
      );
      const categoryTypeSuggestionsEl = document.getElementById(
        "categoryTypeSuggestions"
      );

      loadDataBtn.addEventListener("click", loadData);
      addToolBtn.addEventListener("click", () => showEditForm(null));
      editForm.addEventListener("submit", saveTool);
      deleteToolBtn.addEventListener("click", deleteTool);
      cancelEditBtn.addEventListener("click", hideEditForm);
      copyOutputBtn.addEventListener("click", copyOutputToClipboard);

      function displayError(element, message) {
        element.textContent = message;
        element.classList.remove("hidden");
      }

      function clearError(element) {
        element.textContent = "";
        element.classList.add("hidden");
      }

      function updateSuggestions() {
        suggestions.categories.clear();
        suggestions.platforms.clear();
        suggestions.categoryTypes.clear();

        for (const key in currentToolsData) {
          const tool = currentToolsData[key];
          if (tool.category) suggestions.categories.add(tool.category.trim());
          if (tool.platform) {
            tool.platform
              .split(",")
              .map((p) => p.trim())
              .filter((p) => p)
              .forEach((p) => suggestions.platforms.add(p));
          }
          if (tool.categoryType)
            suggestions.categoryTypes.add(tool.categoryType.trim());
        }

        populateDatalist(categorySuggestionsEl, suggestions.categories);
        populateDatalist(platformSuggestionsEl, suggestions.platforms);
        populateDatalist(categoryTypeSuggestionsEl, suggestions.categoryTypes);
      }

      function populateDatalist(datalistElement, suggestionsSet) {
        datalistElement.innerHTML = "";

        [...suggestionsSet].sort().forEach((suggestion) => {
          const option = document.createElement("option");
          option.value = suggestion;
          datalistElement.appendChild(option);
        });
      }

      function loadData() {
        clearError(loadError);
        const inputString = dataInput.value.trim();
        if (!inputString) {
          displayError(loadError, "Input data is empty.");
          return;
        }

        try {
          let parsableString = inputString;
          if (
            parsableString.startsWith("const") ||
            parsableString.startsWith("var") ||
            parsableString.startsWith("let")
          ) {
            parsableString = parsableString.substring(
              parsableString.indexOf("{")
            );
          }
          if (parsableString.endsWith(";")) {
            parsableString = parsableString.slice(0, -1);
          }

          currentToolsData = new Function(`return ${parsableString}`)();

          if (
            typeof currentToolsData !== "object" ||
            currentToolsData === null ||
            Array.isArray(currentToolsData)
          ) {
            throw new Error("Parsed data is not a valid object map.");
          }

          console.log("Data loaded:", currentToolsData);
          updateSuggestions();
          renderToolList();
          manageArea.classList.remove("hidden");
          outputArea.classList.remove("hidden");
          updateOutput();
          hideEditForm();
        } catch (error) {
          console.error("Parsing failed:", error);

          try {
            currentToolsData = JSON.parse(inputString);
            if (
              typeof currentToolsData !== "object" ||
              currentToolsData === null ||
              Array.isArray(currentToolsData)
            ) {
              throw new Error("Parsed JSON is not a valid object map.");
            }
            console.log("Data loaded via JSON.parse:", currentToolsData);
            updateSuggestions();
            renderToolList();
            manageArea.classList.remove("hidden");
            outputArea.classList.remove("hidden");
            updateOutput();
            hideEditForm();
          } catch (jsonError) {
            console.error("JSON parsing also failed:", jsonError);
            displayError(
              loadError,
              `Failed to parse data. Ensure it's a valid JavaScript object literal or JSON. Error: ${error.message} / ${jsonError.message}`
            );
            manageArea.classList.add("hidden");
            outputArea.classList.add("hidden");
            currentToolsData = {};
          }
        }
      }

      function renderToolList() {
        toolList.innerHTML = "";
        const keys = Object.keys(currentToolsData);

        if (keys.length === 0) {
          toolList.innerHTML =
            '<p style="padding: 15px; color: var(--secondary-color);">No tools loaded or defined yet. Click "Add New Tool" to start.</p>';
          return;
        }

        keys.sort().forEach((key) => {
          const tool = currentToolsData[key] || {};
          const item = document.createElement("div");
          item.classList.add("tool-item");

          const infoSpan = document.createElement("span");
          const keySpan = document.createElement("span");
          keySpan.classList.add("tool-key");
          keySpan.textContent = key;
          infoSpan.appendChild(keySpan);
          infoSpan.appendChild(
            document.createTextNode(`: ${tool.title || "(No Title)"}`)
          );
          item.appendChild(infoSpan);

          const editButton = document.createElement("button");
          editButton.textContent = "Edit";
          editButton.addEventListener("click", (e) => {
            e.stopPropagation();
            showEditForm(key);
          });
          item.appendChild(editButton);

          toolList.appendChild(item);
        });
      }

      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function showEditForm(toolKey) {
        clearError(saveError);
        editForm.reset();
        document.getElementById("editToolId").value = toolKey || "";

        if (toolKey) {
          const toolData = currentToolsData[toolKey];
          formTitle.textContent = `Edit Tool: ${toolKey}`;
          deleteToolBtn.classList.remove("hidden");
          document.getElementById("editToolKey").value = toolKey;
          document.getElementById("editToolKey").readOnly = true;

          document.getElementById("editTitle").value = toolData.title || "";
          document.getElementById("editImage").value = toolData.image || "";
          document.getElementById("editImageLarge").value =
            toolData.imageLarge || "";
          document.getElementById("editCategory").value =
            toolData.category || "";
          document.getElementById("editVersion").value = toolData.version || "";
          document.getElementById("editUpdated").value = toolData.updated || "";
          document.getElementById("editDescription").value =
            toolData.description || "";
          document.getElementById("editDetailedDescription").value =
            toolData.detailedDescription || "";
          document.getElementById("editDownloadUrl").value =
            toolData.downloadUrl || "";
          document.getElementById("editDownloadUrlWindows").value =
            toolData.downloadUrl_windows || "";
          document.getElementById("editDownloadUrlLinux").value =
            toolData.downloadUrl_linux || "";
          document.getElementById("editDocsUrl").value = toolData.docsUrl || "";
          document.getElementById("editPlatform").value =
            toolData.platform || "";
          document.getElementById("editCategoryType").value =
            toolData.categoryType || "";
        } else {
          formTitle.textContent = "Add New Tool";
          deleteToolBtn.classList.add("hidden");

          let i = 1;
          let suggestedKey = `newTool${i}`;
          while (currentToolsData.hasOwnProperty(suggestedKey)) {
            i++;
            suggestedKey = `newTool${i}`;
          }
          document.getElementById("editToolKey").value = suggestedKey;
          document.getElementById("editToolKey").readOnly = false;
          document.getElementById("editUpdated").value = getTodayDateString();
        }

        editFormContainer.classList.remove("hidden");
        editFormContainer.scrollIntoView({
          behavior: "smooth",
          block: "start",
        });
        document.getElementById("editToolKey").focus();
      }

      function hideEditForm() {
        editFormContainer.classList.add("hidden");
        editForm.reset();
        clearError(saveError);

        document.getElementById("editToolKey").readOnly = false;
      }

      function saveTool(event) {
        event.preventDefault();
        clearError(saveError);

        const originalKey = document.getElementById("editToolId").value;
        const newKey = document.getElementById("editToolKey").value.trim();

        if (!newKey) {
          displayError(saveError, "Tool Key is required.");
          document.getElementById("editToolKey").focus();
          return;
        }

        if (!/^[a-zA-Z0-9-_]+$/.test(newKey)) {
          displayError(
            saveError,
            "Tool Key can only contain letters, numbers, hyphens (-), and underscores (_)."
          );
          document.getElementById("editToolKey").focus();
          return;
        }

        if (!originalKey || originalKey !== newKey) {
          if (currentToolsData.hasOwnProperty(newKey)) {
            displayError(
              saveError,
              `Tool Key "${newKey}" already exists. Choose a unique key.`
            );
            document.getElementById("editToolKey").focus();
            return;
          }
        }

        const toolData = {
          title: document.getElementById("editTitle").value.trim(),
          image: document.getElementById("editImage").value.trim(),
          imageLarge: document.getElementById("editImageLarge").value.trim(),
          category: document.getElementById("editCategory").value.trim(),
          version: document.getElementById("editVersion").value.trim(),
          updated: document.getElementById("editUpdated").value.trim(),
          description: document.getElementById("editDescription").value.trim(),
          detailedDescription: document
            .getElementById("editDetailedDescription")
            .value.trim(),
          downloadUrl: document.getElementById("editDownloadUrl").value.trim(),
          downloadUrl_windows: document
            .getElementById("editDownloadUrlWindows")
            .value.trim(),
          downloadUrl_linux: document
            .getElementById("editDownloadUrlLinux")
            .value.trim(),
          docsUrl: document.getElementById("editDocsUrl").value.trim(),
          platform: document.getElementById("editPlatform").value.trim(),
          categoryType: document
            .getElementById("editCategoryType")
            .value.trim(),
        };

        Object.keys(toolData).forEach((key) => {
          if (
            toolData[key] === "" ||
            toolData[key] === null ||
            toolData[key] === undefined
          ) {
            if (toolData[key] === "") {
              delete toolData[key];
            }
          }
        });

        if (!toolData.downloadUrl_windows) delete toolData.downloadUrl_windows;
        if (!toolData.downloadUrl_linux) delete toolData.downloadUrl_linux;
        if (!toolData.downloadUrl) delete toolData.downloadUrl;

        if (
          originalKey &&
          originalKey !== newKey &&
          currentToolsData.hasOwnProperty(originalKey)
        ) {
          delete currentToolsData[originalKey];
        }

        currentToolsData[newKey] = toolData;

        console.log("Tool saved:", newKey, toolData);
        updateSuggestions();
        renderToolList();
        updateOutput();
        hideEditForm();
      }

      function deleteTool() {
        const toolKey = document.getElementById("editToolId").value;
        if (!toolKey || !currentToolsData.hasOwnProperty(toolKey)) {
          displayError(
            saveError,
            "Cannot delete: Invalid tool key or tool not found."
          );
          return;
        }

        if (
          confirm(
            `Are you sure you want to delete the tool "${toolKey}"? This action cannot be undone.`
          )
        ) {
          delete currentToolsData[toolKey];
          console.log("Tool deleted:", toolKey);
          updateSuggestions();
          renderToolList();
          updateOutput();
          hideEditForm();
        }
      }

      function updateOutput() {
        try {
          dataOutput.value = JSON.stringify(currentToolsData, null, 2);
          clearError(loadError);
        } catch (error) {
          dataOutput.value = "Error generating output JSON.";
          console.error("Error stringifying data:", error);
          displayError(loadError, `Error generating output: ${error.message}`);
        }
        clearCopyStatus();
      }

      async function copyOutputToClipboard() {
        if (!navigator.clipboard) {
          dataOutput.select();
          try {
            document.execCommand("copy");
            copyStatus.textContent = "Copied! (fallback method)";
            copyStatus.className = "success";
            setTimeout(clearCopyStatus, 2500);
          } catch (err) {
            copyStatus.textContent = "Copy failed!";
            copyStatus.className = "fail";
            console.error("Fallback copy failed: ", err);
          }
          window.getSelection().removeAllRanges();
          return;
        }

        try {
          await navigator.clipboard.writeText(dataOutput.value);
          copyStatus.textContent = "Copied!";
          copyStatus.className = "success";
          setTimeout(clearCopyStatus, 2000);
        } catch (err) {
          copyStatus.textContent = "Copy failed!";
          copyStatus.className = "fail";
          console.error("Async copy failed: ", err);
        }
      }

      function clearCopyStatus() {
        copyStatus.textContent = "";
        copyStatus.className = "";
      }
    </script>
  </body>
</html>
