<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-touch-fullscreen" content="yes" />
  <meta name="apple-mobile-web-app-title" content="PEX Server edit" />
  <link rel="icon" href="https://pexserver.github.io/lib/Assets/images/home.png" type="image/x-icon" />
  <link rel="shortcut icon" href="https://pexserver.github.io/lib/Assets/images/home.png" type="image/x-icon" />
  <title>toolsData Editor Enhanced</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-color: #dee2e6;
      --input-bg: #fff;
      --input-border: #ced4da;
      --input-focus-border: #80bdff;
      --input-focus-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      --body-bg: #f4f7f9;
      --text-color: #212529;
      --link-color: #007bff;
      --markdown-bg: #eef2f5;
      --code-bg: #e9ecef;
      --container-bg: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --border-radius: 0.3rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 1rem;
      background-color: var(--body-bg);
      color: var(--text-color);
      margin: 0;
      font-size: 16px;
    }

    .container {
      max-width: 960px;
      margin: 1.5rem auto;
      background-color: var(--container-bg);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    h1,
    h2,
    h3 {
      color: var(--dark-color);
      margin-top: 1.8em;
      margin-bottom: 1em;
      padding-bottom: 0.5em;
      border-bottom: 1px solid var(--border-color);
    }

    h1 {
      font-size: 2.2em;
      border-bottom: 2px solid var(--primary-color);
    }

    h2 {
      font-size: 1.7em;
    }

    h3 {
      font-size: 1.4em;
      border-bottom-style: dashed;
    }

    textarea,
    input[type="text"],
    input[type="date"],
    input[type="url"] {
      display: block;
      width: 100%;
      padding: 0.65rem 0.9rem;
      margin-bottom: 0.9rem;
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--text-color);
      background-color: var(--input-bg);
      background-clip: padding-box;
      border: 1px solid var(--input-border);
      border-radius: var(--border-radius);
      transition:
        border-color 0.15s ease-in-out,
        box-shadow 0.15s ease-in-out;
    }

    textarea:focus,
    input:focus {
      color: var(--text-color);
      background-color: var(--input-bg);
      border-color: var(--input-focus-border);
      outline: 0;
      box-shadow: var(--input-focus-shadow);
    }

    textarea {
      min-height: 120px;
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
      resize: vertical;
    }

    #dataInput {
      min-height: 180px;
    }

    #dataOutput {
      min-height: 220px;
      background-color: var(--code-bg);
      border-color: var(--border-color);
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
    }

    #editForm textarea {
      min-height: 80px;
    }

    #editDetailedDescription {
      min-height: 150px;
    }

    #editDescription,
    #editDetailedDescription {
      background-color: var(--markdown-bg);
      border-left: 3px solid var(--info-color);
    }

    #editDescription:focus,
    #editDetailedDescription:focus {
      background-color: var(--input-bg);
    }

    button {
      display: inline-block;
      font-weight: 400;
      color: #fff;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      background-color: transparent;
      border: 1px solid transparent;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: var(--border-radius);
      transition:
        color 0.15s ease-in-out,
        background-color 0.15s ease-in-out,
        border-color 0.15s ease-in-out,
        box-shadow 0.15s ease-in-out,
        transform 0.1s ease-out;
      margin: 0.3rem;
    }

    button:not(:disabled):not(.disabled) {
      cursor: pointer;
    }

    button:hover {
      filter: brightness(95%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    button:active {
      filter: brightness(90%);
      transform: translateY(0px);
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    #loadDataBtn,
    #addToolBtn,
    .tool-item button {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    #saveToolBtn {
      background-color: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    #deleteToolBtn {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
      color: white;
    }

    #cancelEditBtn,
    #copyOutputBtn {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: white;
    }

    #toolList {
      margin-top: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
      background-color: #fff;
    }

    #toolList::-webkit-scrollbar {
      width: 8px;
    }

    #toolList::-webkit-scrollbar-track {
      background: var(--light-color);
      border-radius: 4px;
    }

    #toolList::-webkit-scrollbar-thumb {
      background-color: var(--secondary-color);
      border-radius: 4px;
      border: 2px solid var(--light-color);
    }

    #toolList::-webkit-scrollbar-thumb:hover {
      background-color: var(--dark-color);
    }

    .tool-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.9rem 1.2rem;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.15s ease;
    }

    .tool-item:last-child {
      border-bottom: none;
    }

    .tool-item:hover {
      background-color: var(--light-color);
    }

    .tool-item span {
      flex-grow: 1;
      margin-right: 1rem;
      word-break: break-word;
    }

    .tool-item .tool-key {
      font-weight: 600;
      color: var(--primary-color);
      margin-right: 0.4rem;
      font-size: 0.9em;
      background-color: var(--light-color);
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid var(--border-color);
    }

    .tool-item button {
      padding: 0.3rem 0.7rem;
      font-size: 0.85rem;
    }

    #editFormContainer {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1.8rem;
      margin-top: 1.8rem;
      background-color: #fff;
      box-shadow: var(--shadow-sm);
    }

    #editForm label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 0.9rem;
    }

    #editForm label .required {
      color: var(--danger-color);
      margin-left: 0.25rem;
      font-weight: bold;
    }

    input.pasting {
      opacity: 0.7;
      cursor: progress;
      background-color: var(--warning-color) !important;
      border-color: darken(var(--warning-color), 10%) !important;
    }

    #editForm .form-buttons {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      justify-content: flex-start;
    }

    .hidden {
      display: none !important;
    }

    .error,
    .paste-error {
      color: var(--danger-color);
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 0.75rem 1.25rem;
      border-radius: var(--border-radius);
      margin-top: 0.8rem;
      font-size: 0.9rem;
    }

    #saveError {
      margin-top: 1rem;
    }

    .paste-error {
      font-size: 0.85rem;
      margin-top: -0.6rem;
      margin-bottom: 0.8rem;
      display: block;
    }

    #copyStatus {
      margin-left: 0.8rem;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      transition: opacity 0.3s ease-out;
    }

    #copyStatus.success {
      color: var(--success-color);
      background-color: #d4edda;
    }

    #copyStatus.fail {
      color: var(--danger-color);
      background-color: #f8d7da;
    }

    .required {
      color: var(--danger-color);
      font-weight: bold;
      margin-left: 2px;
    }

    datalist {
      display: none;
    }

    fieldset {
      border: 1px solid var(--border-color);
      padding: 1rem 1.2rem;
      margin-top: 1.5rem;
      border-radius: var(--border-radius);
      background-color: var(--light-color);
    }

    legend {
      padding: 0 0.6rem;
      font-weight: 600;
      font-size: 1rem;
      color: var(--secondary-color);
    }

    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 1.8em;
      }

      h2 {
        font-size: 1.4em;
      }

      h3 {
        font-size: 1.2em;
      }

      textarea,
      input[type="text"],
      input[type="date"],
      input[type="url"],
      button {
        font-size: 0.95rem;
        padding: 0.6rem 0.8rem;
      }

      #editForm .form-buttons {
        flex-direction: column;
        align-items: stretch;
      }

      #editForm .form-buttons button {
        width: 100%;
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>
      toolsData Editor
      <small style="font-size: 0.6em; color: var(--secondary-color)">(Enhanced)</small>
    </h1>

    <section id="inputArea">
      <h2>1. Load toolsData</h2>
      <p>
        既存の <code>toolsData</code> オブジェクトの内容全体 (<code>const toolsData = { ... };</code>
        の <code>{...}</code> の部分、またはJSON形式) を以下に貼り付けて「Load
        Data」ボタンを押してください。
      </p>
      <textarea id="dataInput" placeholder="{
    'tool1': {
        title: 'Example Tool',
        // ... other properties ...
    },
    // ... other tools ...
}"></textarea>
      <button id="loadDataBtn">Load Data</button>
      <div id="loadError" class="error hidden"></div>
    </section>

    <section id="manageArea" class="hidden">
      <h2>2. Manage Tools</h2>
      <div style="margin-bottom: 1rem">
        <button id="addToolBtn">Add New Tool</button>
      </div>
      <div id="toolList">
        <p style="padding: 1rem 1.2rem; color: var(--secondary-color)">
          Load data to see tools.
        </p>
      </div>

      <div id="editFormContainer" class="hidden">
        <h3 id="formTitle">Edit Tool</h3>
        <form id="editForm" novalidate="">
          <input type="hidden" id="editToolId" />

          <div>
            <label for="editToolKey">Tool Key<span class="required">*</span> (例: 'myTool',
              'utility-abc'):</label>
            <input type="text" id="editToolKey" required="" />
          </div>

          <div>
            <label for="editTitle">Title:</label>
            <input type="text" id="editTitle" />
          </div>

          <div>
            <label for="editImage">Image URL (クリップボードから画像ペースト可):</label>
            <input type="url" id="editImage" placeholder="例: ../Assets/images/tool.png またはペースト" />
            <small id="editImagePasteError" class="paste-error hidden"></small>
          </div>

          <div>
            <label for="editImageLarge">Large Image URL (クリップボードから画像ペースト可):</label>
            <input type="url" id="editImageLarge" placeholder="例: ../Assets/images/tool-large.png またはペースト" />
            <small id="editImageLargePasteError" class="paste-error hidden"></small>
          </div>

          <div>
            <label for="editCategory">Category:</label>
            <input type="text" id="editCategory" list="categorySuggestions" placeholder="例: 開発ツール, Minecraft" />
            <datalist id="categorySuggestions"></datalist>
          </div>

          <div>
            <label for="editVersion">Version:</label>
            <input type="text" id="editVersion" placeholder="例: 1.2.0" />
          </div>

          <div>
            <label for="editUpdated">Updated:</label>
            <input type="date" id="editUpdated" />
          </div>

          <div>
            <label for="editDescription">Description (Short)
              <small style="color: var(--info-color); font-weight: normal">(Markdown supported)</small>:</label>
            <textarea id="editDescription" placeholder="短い説明をMarkdownで入力...
例: **重要な** ツールです。"></textarea>
          </div>

          <div>
            <label for="editDetailedDescription">Detailed Description
              <small style="color: var(--info-color); font-weight: normal">(Markdown supported)</small>:</label>
            <textarea id="editDetailedDescription" placeholder="詳細な説明をMarkdownで入力...
例:
## 機能
* 機能1
* 機能2

```js
console.log('Hello');
```"></textarea>
          </div>

          <fieldset>
            <legend>Download URLs</legend>
            <div>
              <label for="editDownloadUrl">Download URL (Default/Single):</label>
              <input type="text" id="editDownloadUrl" placeholder="例: ./File/tool.zip (If no platform-specific URLs)" />
            </div>
            <div>
              <label for="editDownloadUrlWindows">Download URL (Windows):</label>
              <input type="text" id="editDownloadUrlWindows" placeholder="例: ./File/tool_win.exe" />
            </div>
            <div>
              <label for="editDownloadUrlLinux">Download URL (Linux):</label>
              <input type="text" id="editDownloadUrlLinux" placeholder="例: ./File/tool_linux.tar.gz" />
            </div>
          </fieldset>

          <div>
            <label for="editDocsUrl">Docs URL:</label>
            <input type="url" id="editDocsUrl" placeholder="例: ./docs/tool_readme.html" />
          </div>

          <div>
            <label for="editPlatform">Platform:</label>
            <input type="text" id="editPlatform" list="platformSuggestions"
              placeholder="例: web, windows, linux (カンマ区切り)" />
            <datalist id="platformSuggestions"></datalist>
          </div>

          <div>
            <label for="editCategoryType">Category Type:</label>
            <input type="text" id="editCategoryType" list="categoryTypeSuggestions"
              placeholder="例: development, utility, minecraft" />
            <datalist id="categoryTypeSuggestions"></datalist>
          </div>

          <div class="form-buttons">
            <button type="submit" id="saveToolBtn">Save Tool</button>
            <button type="button" id="deleteToolBtn" class="hidden">
              Delete Tool
            </button>
            <button type="button" id="cancelEditBtn">Cancel</button>
          </div>
          <div id="saveError" class="error hidden"></div>
        </form>
      </div>
    </section>

    <section id="outputArea" class="hidden">
      <h2>3. Get Updated Data</h2>
      <p>
        編集後の
        <code>toolsData</code>
        オブジェクトです。コピーしてコードに貼り付けてください (JSON形式)。<br />
        <small>DescriptionフィールドはMarkdownから変換されたHTMLが格納されます。</small>
      </p>
      <textarea id="dataOutput" readonly=""></textarea>
      <button id="copyOutputBtn">Copy to Clipboard</button>
      <span id="copyStatus"></span>
    </section>
  </div>

  <script>
    let currentToolsData = {};
    const suggestions = {
      categories: new Set(),
      platforms: new Set(),
      categoryTypes: new Set(),
    };


    const dataInput = document.getElementById("dataInput");
    const loadDataBtn = document.getElementById("loadDataBtn");
    const loadError = document.getElementById("loadError");
    const manageArea = document.getElementById("manageArea");
    const toolList = document.getElementById("toolList");
    const addToolBtn = document.getElementById("addToolBtn");
    const editFormContainer = document.getElementById("editFormContainer");
    const editForm = document.getElementById("editForm");
    const formTitle = document.getElementById("formTitle");
    const saveToolBtn = document.getElementById("saveToolBtn");
    const deleteToolBtn = document.getElementById("deleteToolBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveError = document.getElementById("saveError");
    const outputArea = document.getElementById("outputArea");
    const dataOutput = document.getElementById("dataOutput");
    const copyOutputBtn = document.getElementById("copyOutputBtn");
    const copyStatus = document.getElementById("copyStatus");

    const categorySuggestionsEl = document.getElementById("categorySuggestions");
    const platformSuggestionsEl = document.getElementById("platformSuggestions");
    const categoryTypeSuggestionsEl = document.getElementById("categoryTypeSuggestions");

    const editImageInput = document.getElementById("editImage");
    const editImageLargeInput = document.getElementById("editImageLarge");
    const editImagePasteError = document.getElementById("editImagePasteError");
    const editImageLargePasteError = document.getElementById("editImageLargePasteError");


    const editDescriptionInput = document.getElementById("editDescription");
    const editDetailedDescriptionInput = document.getElementById("editDetailedDescription");



    loadDataBtn.addEventListener("click", handleLoadData);
    addToolBtn.addEventListener("click", () => showEditForm(null));
    editForm.addEventListener("submit", handleSaveTool);
    deleteToolBtn.addEventListener("click", handleDeleteTool);
    cancelEditBtn.addEventListener("click", hideEditForm);
    copyOutputBtn.addEventListener("click", copyOutputToClipboard);
    editImageInput.addEventListener("paste", handleImagePaste);
    editImageLargeInput.addEventListener("paste", handleImagePaste);


    function displayError(element, message) {
      element.textContent = message;
      element.classList.remove("hidden");
    }

    function clearError(element) {
      element.textContent = "";
      element.classList.add("hidden");
    }

    function displayPasteError(inputId, message) {
      const errorElement = document.getElementById(inputId + "PasteError");
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
      }
    }

    function clearPasteError(inputId) {
      const errorElement = document.getElementById(inputId + "PasteError");
      if (errorElement) {
        errorElement.textContent = "";
        errorElement.classList.add("hidden");
      }
    }

    function disableButtons(disabled = true, buttonText = null) {
      const buttons = [loadDataBtn, addToolBtn, saveToolBtn, deleteToolBtn, cancelEditBtn, copyOutputBtn];
      buttons.forEach(btn => {
        if (btn) {
          btn.disabled = disabled;
          if (disabled && btn === saveToolBtn && buttonText) {
            btn.textContent = buttonText;
          } else if (!disabled && btn === saveToolBtn) {

            btn.textContent = "Save Tool";
          } else if (disabled && btn === loadDataBtn && buttonText) {
            btn.textContent = buttonText;
          } else if (!disabled && btn === loadDataBtn) {
            btn.textContent = "Load Data";
          }
        }
      });

      document.querySelectorAll('#toolList button').forEach(btn => btn.disabled = disabled);
    }



    function handleImagePaste(event) {
      const inputElement = event.target;
      const errorElementId = inputElement.id;
      clearPasteError(errorElementId);

      const items = (event.clipboardData || window.clipboardData)?.items;
      if (!items) {
        displayPasteError(errorElementId, "クリップボードデータにアクセスできません。");
        return;
      }

      let imageFound = false;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();
          if (!blob) {
            displayPasteError(errorElementId, "画像ファイルの取得に失敗しました。");
            continue;
          }
          imageFound = true;
          event.preventDefault();

          const reader = new FileReader();
          const originalPlaceholder = inputElement.placeholder;

          reader.onloadstart = () => {
            inputElement.classList.add('pasting');
            inputElement.readOnly = true;
            inputElement.placeholder = 'Pasting image...';
          };

          reader.onload = (e) => {
            if (e.target && typeof e.target.result === 'string') {
              inputElement.value = e.target.result;
              console.log(`Image pasted and converted to Base64 for ${inputElement.id}`);
            } else {
              displayPasteError(errorElementId, "画像の読み込み結果が無効です。");
            }
          };

          reader.onerror = (error) => {
            console.error("FileReader error:", error);
            displayPasteError(errorElementId, `画像の読み込みに失敗しました: ${error.message || error}`);
          };

          reader.onloadend = () => {
            inputElement.classList.remove('pasting');
            inputElement.readOnly = false;
            inputElement.placeholder = originalPlaceholder;
          };

          reader.readAsDataURL(blob);
          break;
        }
      }

      if (!imageFound) {
        console.log("Pasted content is not an image. Default paste behavior allowed.");
      }
    }


    function updateSuggestions() {
      suggestions.categories.clear();
      suggestions.platforms.clear();
      suggestions.categoryTypes.clear();

      for (const key in currentToolsData) {
        const tool = currentToolsData[key];
        if (tool.category) suggestions.categories.add(tool.category.trim());
        if (tool.platform) {
          tool.platform
            .split(",")
            .map((p) => p.trim())
            .filter((p) => p)
            .forEach((p) => suggestions.platforms.add(p));
        }
        if (tool.categoryType)
          suggestions.categoryTypes.add(tool.categoryType.trim());
      }

      populateDatalist(categorySuggestionsEl, suggestions.categories);
      populateDatalist(platformSuggestionsEl, suggestions.platforms);
      populateDatalist(categoryTypeSuggestionsEl, suggestions.categoryTypes);
    }

    function populateDatalist(datalistElement, suggestionsSet) {
      datalistElement.innerHTML = "";
      [...suggestionsSet].sort().forEach((suggestion) => {
        const option = document.createElement("option");
        option.value = suggestion;
        datalistElement.appendChild(option);
      });
    }



    async function handleLoadData() {
      disableButtons(true, "Loading...");
      clearError(loadError);
      hideEditForm();
      const inputString = dataInput.value.trim();




      if (!inputString) {
        currentToolsData = {};
        console.log("Input data is empty, initializing with empty data.");
      } else {
        try {
          let parsableString = inputString;
          if (parsableString.startsWith("const") || parsableString.startsWith("var") || parsableString.startsWith("let")) {
            parsableString = parsableString.substring(parsableString.indexOf("{"));
          }
          if (parsableString.endsWith(";")) {
            parsableString = parsableString.slice(0, -1);
          }

          currentToolsData = new Function(`return ${parsableString}`)();

          if (typeof currentToolsData !== "object" || currentToolsData === null || Array.isArray(currentToolsData)) {
            throw new Error("Parsed data is not a valid object map.");
          }
          console.log("Data loaded via Function constructor:", currentToolsData);

        } catch (error) {
          console.warn("Parsing as JS object literal failed, trying JSON:", error);
          try {
            currentToolsData = JSON.parse(inputString);
            if (typeof currentToolsData !== "object" || currentToolsData === null || Array.isArray(currentToolsData)) {
              throw new Error("Parsed JSON is not a valid object map.");
            }
            console.log("Data loaded via JSON.parse:", currentToolsData);
          } catch (jsonError) {
            console.error("JSON parsing also failed:", jsonError);
            displayError(loadError, `Failed to parse data. Ensure it's a valid JavaScript object literal or JSON. Error: ${error.message || 'Syntax Error'} / ${jsonError.message}`);
            currentToolsData = {};
            manageArea.classList.add("hidden");
            outputArea.classList.add("hidden");
            disableButtons(false);
            return;
          }
        }
      }

      updateSuggestions();
      renderToolList();
      manageArea.classList.remove("hidden");
      outputArea.classList.remove("hidden");
      updateOutput();
      disableButtons(false);
    }


    function renderToolList() {
      toolList.innerHTML = "";
      const keys = Object.keys(currentToolsData);

      if (keys.length === 0) {
        toolList.innerHTML = `<p style="padding: 1rem 1.2rem; color: var(--secondary-color);">No tools loaded or defined yet. Click "Add New Tool" to start.</p>`;
        return;
      }

      keys.sort().forEach((key) => {
        const tool = currentToolsData[key] || {};
        const item = document.createElement("div");
        item.classList.add("tool-item");

        const infoSpan = document.createElement("span");
        const keySpan = document.createElement("span");
        keySpan.classList.add("tool-key");
        keySpan.textContent = key;
        infoSpan.appendChild(keySpan);
        infoSpan.appendChild(
          document.createTextNode(` ${tool.title || "(No Title)"}`)
        );
        item.appendChild(infoSpan);

        const editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.onclick = (e) => {
          e.stopPropagation();
          showEditForm(key);
        };
        item.appendChild(editButton);

        toolList.appendChild(item);
      });
    }

    function getTodayDateString() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function showEditForm(toolKey) {
      clearError(saveError);
      clearPasteError('editImage');
      clearPasteError('editImageLarge');
      editForm.reset();
      document.getElementById("editToolId").value = toolKey || "";

      if (toolKey && currentToolsData[toolKey]) {
        const toolData = currentToolsData[toolKey];
        formTitle.textContent = `Edit Tool: ${toolKey}`;
        deleteToolBtn.classList.remove("hidden");
        document.getElementById("editToolKey").value = toolKey;
        document.getElementById("editToolKey").readOnly = true;


        document.getElementById("editTitle").value = toolData.title || "";
        document.getElementById("editImage").value = toolData.image || "";
        document.getElementById("editImageLarge").value = toolData.imageLarge || "";
        document.getElementById("editCategory").value = toolData.category || "";
        document.getElementById("editVersion").value = toolData.version || "";
        document.getElementById("editUpdated").value = toolData.updated || "";
        document.getElementById("editDocsUrl").value = toolData.docsUrl || "";
        document.getElementById("editPlatform").value = toolData.platform || "";
        document.getElementById("editCategoryType").value = toolData.categoryType || "";


        editDescriptionInput.value = toolData.descriptionMarkdown !== undefined ? toolData.descriptionMarkdown : (toolData.description || "");
        editDetailedDescriptionInput.value = toolData.detailedDescriptionMarkdown !== undefined ? toolData.detailedDescriptionMarkdown : (toolData.detailedDescription || "");



        if (typeof toolData.downloadUrl === 'object' && toolData.downloadUrl !== null) {
          document.getElementById("editDownloadUrl").value = toolData.downloadUrl.default || "";
          document.getElementById("editDownloadUrlWindows").value = toolData.downloadUrl.windows || "";
          document.getElementById("editDownloadUrlLinux").value = toolData.downloadUrl.linux || "";
        } else {
          document.getElementById("editDownloadUrl").value = toolData.downloadUrl || "";
          document.getElementById("editDownloadUrlWindows").value = toolData.downloadUrl_windows || "";
          document.getElementById("editDownloadUrlLinux").value = toolData.downloadUrl_linux || "";
        }

      } else {
        formTitle.textContent = "Add New Tool";
        deleteToolBtn.classList.add("hidden");
        document.getElementById("editToolKey").readOnly = false;


        let i = 1;
        let suggestedKey = `newTool${i}`;
        while (currentToolsData.hasOwnProperty(suggestedKey)) {
          i++;
          suggestedKey = `newTool${i}`;
        }
        document.getElementById("editToolKey").value = suggestedKey;
        document.getElementById("editUpdated").value = getTodayDateString();


        editDescriptionInput.value = "";
        editDetailedDescriptionInput.value = "";

        document.getElementById("editDownloadUrl").value = "";
        document.getElementById("editDownloadUrlWindows").value = "";
        document.getElementById("editDownloadUrlLinux").value = "";
      }

      editFormContainer.classList.remove("hidden");
      editFormContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });

      setTimeout(() => {
        const firstFocusable = toolKey ? document.getElementById("editTitle") : document.getElementById("editToolKey");
        firstFocusable.focus();
      }, 150);
    }

    function hideEditForm() {
      editFormContainer.classList.add("hidden");
      editForm.reset();
      clearError(saveError);
      clearPasteError('editImage');
      clearPasteError('editImageLarge');
      document.getElementById("editToolKey").readOnly = false;
    }

    async function handleSaveTool(event) {
      event.preventDefault();
      disableButtons(true, "Saving...");
      clearError(saveError);

      const originalKey = document.getElementById("editToolId").value;
      const newKey = document.getElementById("editToolKey").value.trim();

      if (!newKey) {
        displayError(saveError, "Tool Key is required.");
        document.getElementById("editToolKey").focus();
        disableButtons(false);
        return;
      }

      if (!/^[a-zA-Z0-9-_]+$/.test(newKey)) {
        displayError(saveError, "Tool Key can only contain letters, numbers, hyphens (-), and underscores (_).");
        document.getElementById("editToolKey").focus();
        disableButtons(false);
        return;
      }

      if ((!originalKey || originalKey !== newKey) && currentToolsData.hasOwnProperty(newKey)) {
        displayError(saveError, `Tool Key "${newKey}" already exists. Choose a unique key.`);
        document.getElementById("editToolKey").focus();
        disableButtons(false);
        return;
      }





      const descriptionMarkdown = editDescriptionInput.value.trim();
      const detailedDescriptionMarkdown = editDetailedDescriptionInput.value.trim();



      const descriptionHtml = marked.parse(descriptionMarkdown);
      const detailedDescriptionHtml = marked.parse(detailedDescriptionMarkdown);


      const toolData = {
        title: document.getElementById("editTitle").value.trim(),
        image: document.getElementById("editImage").value.trim(),
        imageLarge: document.getElementById("editImageLarge").value.trim(),
        category: document.getElementById("editCategory").value.trim(),
        version: document.getElementById("editVersion").value.trim(),
        updated: document.getElementById("editUpdated").value.trim(),

        descriptionMarkdown: descriptionMarkdown,
        description: descriptionHtml,
        detailedDescriptionMarkdown: detailedDescriptionMarkdown,
        detailedDescription: detailedDescriptionHtml,
        docsUrl: document.getElementById("editDocsUrl").value.trim(),
        platform: document.getElementById("editPlatform").value.trim(),
        categoryType: document.getElementById("editCategoryType").value.trim(),
      };


      const dlDefault = document.getElementById("editDownloadUrl").value.trim();
      const dlWindows = document.getElementById("editDownloadUrlWindows").value.trim();
      const dlLinux = document.getElementById("editDownloadUrlLinux").value.trim();

      if (dlWindows || dlLinux) {

        if (dlDefault) toolData.downloadUrl = dlDefault;
        if (dlWindows) toolData.downloadUrl_windows = dlWindows;
        if (dlLinux) toolData.downloadUrl_linux = dlLinux;
      } else if (dlDefault) {

        toolData.downloadUrl = dlDefault;
      }


      Object.keys(toolData).forEach((key) => {
        if (key !== 'descriptionMarkdown' && key !== 'detailedDescriptionMarkdown' &&
          (toolData[key] === "" || toolData[key] === null || toolData[key] === undefined)) {
          delete toolData[key];
        }
      });

      if (!toolData.downloadUrl) delete toolData.downloadUrl;
      if (!toolData.downloadUrl_windows) delete toolData.downloadUrl_windows;
      if (!toolData.downloadUrl_linux) delete toolData.downloadUrl_linux;





      if (!descriptionMarkdown) { delete toolData.description; delete toolData.descriptionMarkdown; }
      if (!detailedDescriptionMarkdown) { delete toolData.detailedDescription; delete toolData.detailedDescriptionMarkdown; }




      if (originalKey && originalKey !== newKey && currentToolsData.hasOwnProperty(originalKey)) {
        delete currentToolsData[originalKey];
      }


      currentToolsData[newKey] = toolData;

      console.log("Tool saved:", newKey, toolData);


      updateOutput();
      dataInput.value = dataOutput.value;
      await handleLoadData();


    }

    async function handleDeleteTool() {
      const toolKey = document.getElementById("editToolId").value;
      if (!toolKey || !currentToolsData.hasOwnProperty(toolKey)) {
        displayError(saveError, "Cannot delete: Invalid tool key or tool not found.");
        return;
      }

      if (confirm(`Are you sure you want to delete the tool "${toolKey}"? This action cannot be undone.`)) {
        disableButtons(true, "Deleting...");



        delete currentToolsData[toolKey];
        console.log("Tool deleted:", toolKey);


        updateOutput();
        dataInput.value = dataOutput.value;
        await handleLoadData();


      }
    }

    function updateOutput() {
      try {

        dataOutput.value = JSON.stringify(currentToolsData, null, 2);
        clearError(loadError);
      } catch (error) {
        dataOutput.value = "Error generating output JSON.";
        console.error("Error stringifying data:", error);
        displayError(loadError, `Error generating output: ${error.message}`);
      }
      clearCopyStatus();
    }

    async function copyOutputToClipboard() {
      const textToCopy = dataOutput.value;
      if (!textToCopy) {
        showCopyStatus("Nothing to copy.", false);
        return;
      }

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(textToCopy);
          showCopyStatus("Copied!", true);
        } else {

          dataOutput.select();
          if (document.execCommand('copy')) {
            showCopyStatus("Copied! (fallback)", true);
          } else {
            throw new Error('Fallback copy command failed');
          }
          window.getSelection()?.removeAllRanges();
          dataOutput.blur();
        }
      } catch (err) {
        console.error("Copy failed: ", err);
        showCopyStatus("Copy failed!", false);
      }
    }

    function showCopyStatus(message, success) {
      copyStatus.textContent = message;
      copyStatus.className = success ? 'success' : 'fail';
      copyStatus.style.opacity = '1';
      setTimeout(clearCopyStatus, success ? 2000 : 3000);
    }

    function clearCopyStatus() {
      copyStatus.style.opacity = '0';

      setTimeout(() => {
        copyStatus.textContent = "";
        copyStatus.className = "";
      }, 300);
    }
  </script>
</body>

</html>